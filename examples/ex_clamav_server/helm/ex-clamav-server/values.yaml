# =============================================================================
# ExClamavServer Helm Chart - Default Values
# =============================================================================

# -- Number of replicas (StatefulSet)
replicaCount: 2

image:
  repository: ex-clamav-server
  pullPolicy: IfNotPresent
  # -- Override the image tag (default is the chart appVersion)
  tag: ""

imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""

# =============================================================================
# Application Configuration
# =============================================================================
config:
  # -- HTTP port the application listens on
  port: 4000

  # -- Log level: debug, info, warning, error
  logLevel: info

  # -- Maximum upload file size in bytes (default: 100MB)
  maxUploadSize: "104857600"

  # -- ClamAV database path (inside the container / shared volume)
  clamavDbPath: /var/lib/clamav

  # -- Upload storage path (inside the container / shared volume)
  uploadPath: /data/uploads

  # -- Interval (in hours) between virus definition updates
  clamavUpdateIntervalHours: "1"

  # -- Whether to run freshclam on application start
  clamavUpdateOnStart: "true"

  # -- Optional path to a custom freshclam.conf
  freshclamConfig: ""

  # -- Database connection pool size per instance
  poolSize: "20"

  # -- Enable SSL for database connections
  databaseSsl: "false"

# -- Existing secret containing DATABASE_URL
# If set, the chart will not create its own database URL from the postgresql subchart.
existingDatabaseSecret: ""
existingDatabaseSecretKey: "DATABASE_URL"

# =============================================================================
# Service Account
# =============================================================================
serviceAccount:
  create: true
  automount: true
  annotations: {}
  name: ""

# =============================================================================
# Pod Configuration
# =============================================================================
podAnnotations: {}

podLabels: {}

podSecurityContext:
  fsGroup: 1000
  runAsNonRoot: true

securityContext:
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: false
  runAsNonRoot: true
  runAsUser: 1000
  runAsGroup: 1000
  capabilities:
    drop:
      - ALL

# =============================================================================
# Service
# =============================================================================
service:
  type: ClusterIP
  port: 80
  targetPort: 4000
  annotations: {}

# =============================================================================
# Ingress
# =============================================================================
ingress:
  enabled: false
  className: "alb"
  annotations:
    # -- ALB ingress annotations for EKS
    # alb.ingress.kubernetes.io/scheme: internet-facing
    # alb.ingress.kubernetes.io/target-type: ip
    # alb.ingress.kubernetes.io/healthcheck-path: /health
    # alb.ingress.kubernetes.io/healthcheck-interval-seconds: "30"
    # alb.ingress.kubernetes.io/listen-ports: '[{"HTTPS": 443}]'
    # alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:...
    {}
  hosts:
    - host: clamav-api.example.com
      paths:
        - path: /
          pathType: Prefix
  tls: []
  #  - secretName: clamav-api-tls
  #    hosts:
  #      - clamav-api.example.com

# =============================================================================
# Resources
# =============================================================================
resources:
  requests:
    cpu: 500m
    memory: 512Mi
  limits:
    cpu: "2"
    memory: 2Gi

# =============================================================================
# Probes
# =============================================================================
# ClamAV engine loading can take 30-60 seconds, so startupProbe is generous
startupProbe:
  httpGet:
    path: /health
    port: http
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 12

livenessProbe:
  httpGet:
    path: /health
    port: http
  periodSeconds: 30
  timeoutSeconds: 5
  failureThreshold: 3

readinessProbe:
  httpGet:
    path: /health
    port: http
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

# =============================================================================
# Autoscaling (HPA)
# =============================================================================
autoscaling:
  enabled: false
  minReplicas: 2
  maxReplicas: 10
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80

# =============================================================================
# Persistent Volumes
# =============================================================================
persistence:
  # -- Shared volume for uploaded files
  # On EKS, use EFS (ReadWriteMany) so all pods can access uploads.
  uploads:
    enabled: true
    # -- Storage class for the uploads volume
    # Use "efs-sc" for EFS on EKS (requires EFS CSI driver)
    storageClass: "efs-sc"
    accessModes:
      - ReadWriteMany
    size: 50Gi
    # -- Use an existing PVC instead of creating one
    existingClaim: ""
    # -- Mount path inside the container
    mountPath: /data/uploads
    # -- Annotations for the PVC
    annotations: {}

  # -- Shared volume for ClamAV virus definitions
  # Sharing the virus DB across pods avoids redundant freshclam downloads.
  # On EKS, use EFS (ReadWriteMany).
  clamavDb:
    enabled: true
    storageClass: "efs-sc"
    accessModes:
      - ReadWriteMany
    size: 5Gi
    existingClaim: ""
    mountPath: /var/lib/clamav
    annotations: {}

# =============================================================================
# Node Scheduling
# =============================================================================
nodeSelector: {}

tolerations: []

affinity: {}

# -- Pod topology spread constraints for distributing across AZs
topologySpreadConstraints: []
# - maxSkew: 1
#   topologyKey: topology.kubernetes.io/zone
#   whenUnsatisfiable: DoNotSchedule
#   labelSelector:
#     matchLabels:
#       app.kubernetes.io/name: ex-clamav-server

# =============================================================================
# Pod Disruption Budget
# =============================================================================
podDisruptionBudget:
  enabled: true
  minAvailable: 1
  # maxUnavailable: 1

# =============================================================================
# Extra environment variables
# =============================================================================
# -- Additional environment variables to set on the container
extraEnv: []
# - name: EXTRA_VAR
#   value: "extra-value"

# -- Additional environment variables from secrets or configmaps
extraEnvFrom: []
# - secretRef:
#     name: my-secret
# - configMapRef:
#     name: my-configmap

# =============================================================================
# Init Containers
# =============================================================================
# -- Optional init container to pre-download virus definitions
# This is useful when the shared volume is initially empty.
initContainers:
  freshclam:
    enabled: true
    image:
      repository: clamav/clamav
      tag: "1.4"
      pullPolicy: IfNotPresent
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi

# =============================================================================
# PostgreSQL Subchart (Bitnami)
# =============================================================================
postgresql:
  enabled: true
  auth:
    postgresPassword: "changeme"
    username: "ex_clamav_server"
    password: "changeme"
    database: "ex_clamav_server_prod"
  primary:
    persistence:
      enabled: true
      size: 10Gi
    resources:
      requests:
        cpu: 250m
        memory: 256Mi
      limits:
        cpu: "1"
        memory: 1Gi
